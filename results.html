<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Результаты теста PDQ-4</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <main class="container results">
    <h1>Результаты теста PDQ-4</h1>
    <p class="subtitle">Выраженность личностных черт</p>

    <div class="grid">
      <div class="col" id="col1"></div>
      <div class="col" id="col2"></div>
    </div>

    <button class="button" style="margin-top: 20px;" onclick="window.location.href='index.html'">Пройти снова</button>
  </main>

  <script type="module">
  import { calculateResults } from "./js/calculateResults.mjs";

  const answers = JSON.parse(localStorage.getItem("pdqAnswers")) || [];

  const LEFT_ORDER = [
    "Параноидальное", "Шизоидное", "Шизотипическое",
    "Истерическое", "Нарциссическое", "Пограничное", "Антисоциальное"
  ];
  const RIGHT_ORDER = [
    "Избегающее", "Зависимое",
    "Обсессивно-компульсивное", "Депрессивное", "Пассивно-агрессивное"
  ];

  const LABEL_MAP = {
    "Параноидальное": "Параноидная ЧЛ",
    "Шизоидное": "Шизоидная ЧЛ",
    "Шизотипическое": "Шизотипическая ЧЛ",
    "Истерическое": "Истерическая ЧЛ",
    "Нарциссическое": "Нарциссическая ЧЛ",
    "Пограничное": "Пограничная ЧЛ",
    "Антисоциальное": "Антисоциальная ЧЛ",
    "Избегающее": "Избегающая ЧЛ",
    "Зависимое": "Зависимая ЧЛ",
    "Обсессивно-компульсивное": "Обсессивно-компульсивная ЧЛ",
    "Депрессивное": "Депрессивная ЧЛ",
    "Пассивно-агрессивное": "Пассивно-агрессивная ЧЛ"
  };

  function color(score, th) {
    if (score >= th) return "var(--red)";
    if (score >= th - 2) return "var(--yellow)";
    return "var(--green)";
  }

  (async () => {
    const res = await calculateResults(answers);
    const left = document.getElementById("col-left");
    const right = document.getElementById("col-right");

    function row(k) {
      const r = res[k];
      if (!r) return "";
      const w = Math.max(0, Math.min(100, (r.score / r.threshold) * 100));
      const c = color(r.score, r.threshold);
      return `
        <div class="item">
          <div class="label">${LABEL_MAP[k] || k}</div>
          <div class="bar" style="--th:${r.threshold};">
            <div class="fill" style="width:${w}%; background:${c};"></div>
            <div class="value">${r.score} / ${r.threshold}</div>
          </div>
        </div>`;
    }

    left.innerHTML = LEFT_ORDER.map(row).join("");
    right.innerHTML = RIGHT_ORDER.map(row).join("");
  })();
</script>
